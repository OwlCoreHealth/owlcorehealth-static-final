<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Dr. Owl’s AI Office</title>

  <style>
    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
      background-color: #fff;
      margin: 0;
      padding: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
    }
    .container {
      max-width: 600px;
      width: 90%;
      padding: 20px;
      text-align: center;
      position: relative;
    }
    h1 {
      font-weight: 700;
      font-size: 24px;
      margin: 0;
    }
    p.subtitle {
      font-weight: 300;
      font-size: 16px;
      margin: 4px 0 24px 0;
      color: #555;
    }

    /* Logo */
    .logo {
      display: block;
      margin: 0 auto 0 auto;
      width: 80px;
      height: 80px;
      object-fit: contain;
    }

    .menu-hamburger {
      position: fixed;
      top: 0;
      left: 0;
      margin: 0;
      padding: 20px;
      width: 28px;
      height: 22px;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      z-index: 1001;
      box-sizing: content-box;
    }
    .menu-hamburger span {
      display: block;
      height: 3px;
      background-color: #6C63FF;
      border-radius: 2px;
    }

    .side-menu {
      position: fixed;
      top: 0;
      left: -280px;
      width: 280px;
      height: 100vh;
      background: #f8f8f8;
      box-shadow: 2px 0 8px rgba(0,0,0,0.15);
      overflow-y: auto;
      transition: left 0.3s ease;
      z-index: 1000;
      padding: 20px;
      box-sizing: border-box;
    }
    .side-menu.open { left: 0; }
    .side-menu h2 {
      margin-top: 0;
      font-size: 18px;
      font-weight: 700;
      border-bottom: 1px solid #ccc;
      padding-bottom: 6px;
    }
    .side-menu h3 {
      margin-top: 20px;
      font-size: 16px;
      font-weight: 700;
      border-bottom: 1px solid #ccc;
      padding-bottom: 4px;
    }
    .side-menu ul {
      list-style: none;
      padding-left: 0;
      margin: 8px 0 0 0;
    }
    .side-menu ul li { margin-bottom: 8px; }
    .side-menu ul li a {
      color: #3a3a8c;
      text-decoration: none;
      font-size: 14px;
      cursor: pointer;
    }
    .side-menu ul li a:hover { text-decoration: underline; }
    .side-menu .close-btn {
      font-size: 20px;
      cursor: pointer;
      margin-bottom: 20px;
      display: block;
      text-align: right;
      color: #6C63FF;
    }

    /* --- Chat layout --- */
    .response {
      max-height: 600px;
      overflow-y: auto;
      width: 67vw;
      max-width: 900px;
      margin: 0 auto 16px auto;
      text-align: left;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      gap: 16px;
      padding-right: 0;
    }

    .bot-message {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      font-weight: 300;
      font-size: 16px;
      color: #222;
      width: 100%;
      box-sizing: border-box;
      padding: 0 12px;
    }

    .bot-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      margin-top: 4px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
    }

    .bot-icon svg {
      width: 24px;
      height: 24px;
      fill: #6C63FF;
    }

    .bot-text {
      flex: 1;
      line-height: 1.6;
      color: #222222;
      font-weight: 400;
      text-align: left;
      margin-right: 12px;
      word-break: break-word;
    }

    .bot-text p { margin: 1em 0; }
    .bot-text ul, .bot-text ol { margin: 1em 0; padding-left: 1.6em; }
    .bot-text ul li, .bot-text ol li { margin-bottom: 0.5em; }
    .bot-text strong, .bot-text b { font-weight: 700; }
    .bot-text h2, .bot-text h3 {
      font-weight: 700;
      margin-top: 1.5em;
      margin-bottom: 0.5em;
      color: #111111;
    }
    .bot-text pre {
      overflow: auto;
      padding: 12px;
      border-radius: 10px;
      background: #f3f3f8;
    }
    .bot-text code {
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size: 0.95em;
    }

    .typing-indicator {
      font-size: 13px;
      color: #666;
      margin-left: 36px;
    }

    .user-message {
      display: inline-block;
      background-color: #EEF3FB;
      color: #000;
      padding: 12px 16px;
      border-radius: 24px 24px 4px 24px;
      margin-left: auto;
      font-weight: 400;
      font-size: 15px;
      line-height: 1.4;
      word-break: break-word;
      box-sizing: border-box;
      max-width: 80%;
      width: fit-content;
    }

    .clickable-question {
      background-color: #CCE4FF;
      color: #000;
      padding: 12px 18px;
      border-radius: 24px 24px 4px 24px;
      font-weight: 400;
      font-size: 16px;
      line-height: 1.4;
      word-wrap: break-word;
      box-sizing: border-box;
      max-width: 80%;
      width: fit-content;
      cursor: pointer;
      user-select: none;
      display: inline-block;
      margin: 8px 0 0 0;
      transition: background-color 0.3s;
    }
    .clickable-question:hover { background-color: #a3c4ff; }

    .input-area {
      position: relative;
      background-color: #ECECF3;
      border-radius: 24px;
      padding: 16px 12px 24px 12px !important;
      height: auto !important;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 10px;
      max-width: 600px;
      margin: 0 auto;
      cursor: text;
      flex-wrap: wrap;
      width: 100% !important;
      box-sizing: border-box;
      margin-bottom: 12px;
    }

    .message-label {
      font-weight: 300;
      font-size: 14px !important;
      color: #333;
      margin: 0;
      text-align: left;
      outline: none;
      user-select: text;
      pointer-events: auto;
      min-height: 36px !important;
      white-space: pre-wrap;
      flex: 1;
      cursor: text;
      width: 100%;
      padding: 6px 8px !important;
      line-height: 1.4 !important;
      box-sizing: border-box;
      word-break: break-word;
    }

    /* Placeholder customizado */
    .message-label[contenteditable]:empty::before {
      content: attr(data-placeholder);
      color: #aaa;
      pointer-events: none;
      display: block;
      font-weight: 300;
      font-size: 14px;
    }

    .left-buttons {
      position: absolute;
      bottom: 8px;
      left: 12px;
      display: flex;
      gap: 6px;
      align-items: center;
      z-index: 1;
    }

    button {
      font-weight: 700;
      font-size: 12px;
      cursor: pointer;
      user-select: none;
      border-radius: 8px;
      padding: 4px 8px;
      background-color: #fff;
      border: 1px solid #ccc;
      color: #333;
      display: flex;
      align-items: center;
      gap: 6px;
      transition: background-color 0.3s, color 0.3s;
    }
    button:hover {
      background-color: #6C63FF;
      border-color: #6C63FF;
      color: white;
    }
    button svg.read-icon {
      width: 14px;
      height: 14px;
      fill: currentColor;
    }

    button#send-btn {
      margin-left: auto;
      background-color: #6C63FF;
      border: none;
      color: white;
      padding: 8px 18px;
      font-weight: 700;
      font-size: 12px;
      border-radius: 16px;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.3s;
      z-index: 1;
    }
    button#send-btn:hover { background-color: #5750d1; }

    .back-to-home {
      position: fixed;
      top: 10px;
      right: 10px;
      background-color: #E3ECF7;
      border: none;
      border-radius: 12px;
      color: #333;
      font-size: 10px;
      padding: 4px 10px;
      z-index: 9999;
      cursor: pointer;
    }
    button.back-to-home:not(#keep-this-button) { display: none !important; }

    body.chat-started h1,
    body.chat-started p.subtitle,
    body.chat-started img.logo {
      display: none !important;
    }

    /* Responsive */
    @media (max-width: 600px) {
      .response {
        width: 100vw !important;
        max-width: 100% !important;
        padding: 0 12px !important;
        box-sizing: border-box;
      }
      .bot-message {
        flex-direction: column;
        align-items: flex-start;
        gap: 8px;
        padding: 0 8px;
      }
      .bot-text { margin-right: 0; }
      .bot-icon svg { width: 20px; height: 20px; }
    }
  </style>

  <!-- IMPORTANT: libs FIRST (safe order) -->
  <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/dompurify@3.1.6/dist/purify.min.js"></script>
</head>

<body>
  <button id="keep-this-button" class="back-to-home" onclick="window.location.href='https://www.naturepharmalab.com/'">
    Back to Homepage
  </button>

  <div class="container">
    <!-- Menu Hamburguer -->
    <div class="menu-hamburger" aria-label="Menu" role="button" tabindex="0"
         onclick="toggleMenu()" onkeydown="if(event.key==='Enter'){toggleMenu();}">
      <span></span><span></span><span></span>
    </div>

    <!-- Menu Lateral -->
    <nav class="side-menu" id="sideMenu" aria-label="Main menu">
      <span class="close-btn" role="button" tabindex="0" aria-label="Close menu"
            onclick="toggleMenu()" onkeydown="if(event.key==='Enter'){toggleMenu();}">&times;</span>

      <h2>Conheça o Dr. Owl</h2>
      <ul>
        <li><a href="#" data-menu="about1">Quem é o Dr. Owl?</a></li>
        <li><a href="#" data-menu="about2">Qual a função do Dr. Owl?</a></li>
        <li><a href="#" data-menu="about3">Como o Dr. Owl pode ajudar?</a></li>
        <li><a href="#" data-menu="about4">Por que confiar no Dr. Owl?</a></li>
        <li><a href="#" data-menu="about5">Quais são os diferenciais do Dr. Owl?</a></li>
      </ul>

      <h3>Sintomas</h3>
      <ul>
        <li><a href="#" data-menu="symA">Quer saber sobre o sintoma A?</a></li>
        <li><a href="#" data-menu="symB">Quer saber como o sintoma B pode agravar sua saúde?</a></li>
        <li><a href="#" data-menu="symC">Como identificar o sintoma C?</a></li>
        <li><a href="#" data-menu="symD">Quais são os riscos do sintoma D?</a></li>
        <li><a href="#" data-menu="symE">Sintoma E: causas comuns?</a></li>
      </ul>

      <h3>Categoria 3</h3>
      <ul>
        <li><a href="#" data-menu="c3q1">Pergunta 1 da categoria 3</a></li>
        <li><a href="#" data-menu="c3q2">Pergunta 2 da categoria 3</a></li>
        <li><a href="#" data-menu="c3q3">Pergunta 3 da categoria 3</a></li>
        <li><a href="#" data-menu="c3q4">Pergunta 4 da categoria 3</a></li>
        <li><a href="#" data-menu="c3q5">Pergunta 5 da categoria 3</a></li>
      </ul>
    </nav>

    <!-- Logo (usa o arquivo do teu repo: owl-doctor.png) -->
    <img class="logo" src="owl-doctor.png" alt="Dr. Owl" />

    <!-- Title -->
    <h1>Hi, I'm Dr. Owl.</h1>
    <p class="subtitle">Let's chat and find solutions together.</p>

    <!-- Chat -->
    <div class="response" id="response"></div>

    <!-- Input Box -->
    <div class="input-area" role="form" aria-label="Chat input area">
      <div
        id="messageInput"
        class="message-label"
        contenteditable="true"
        role="textbox"
        aria-label="Digite sua mensagem aqui"
        data-placeholder="message Dr. Owl"
        tabindex="0"
      ></div>

      <!-- Left Buttons: Read Aloud + Microphone -->
      <div class="left-buttons">
        <button type="button" aria-label="Read aloud" id="read-aloud-btn">
          <svg viewBox="0 0 24 24" aria-hidden="true" focusable="false" fill="currentColor" class="read-icon">
            <path d="M3 10v4h4l5 5V5L7 10H3z"></path>
          </svg>
          Read Aloud
        </button>

        <button type="button" aria-label="Microphone" id="mic-btn">Micro</button>
      </div>

      <!-- Send Button -->
      <button id="send-btn" type="submit" aria-label="Send message">Send</button>
    </div>
  </div>

  <script>
    // ======== SECURITY HARDENING (NO innerHTML from user input) ========
    // 1) User messages: ALWAYS textContent
    // 2) Bot messages: Markdown -> HTML -> DOMPurify sanitize -> insert
    // 3) Clickable questions: ALWAYS textContent + dataset

    // Marked safe-ish configuration (still sanitize afterwards)
    marked.setOptions({
      mangle: false,
      headerIds: false
    });

    // DOMPurify allowlist (keeps markdown formatting but blocks dangerous HTML)
    const PURIFY_CONFIG = {
      ALLOWED_TAGS: [
        'p','br','strong','b','em','i',
        'ul','ol','li',
        'h2','h3','h4',
        'blockquote',
        'code','pre',
        'a','span'
      ],
      ALLOWED_ATTR: ['href','title','target','rel','class']
    };

    function sanitizeBotHtml(unsafeHtml) {
      const clean = DOMPurify.sanitize(unsafeHtml, PURIFY_CONFIG);
      return clean;
    }

    function enforceSafeLinks(containerEl) {
      const links = containerEl.querySelectorAll('a[href]');
      links.forEach(a => {
        a.setAttribute('target', '_blank');
        a.setAttribute('rel', 'noopener noreferrer');
      });
    }

    function createBotIconEl() {
      const wrap = document.createElement('div');
      wrap.className = 'bot-icon';
      wrap.innerHTML = `
        <svg width="24" height="24" viewBox="0 0 24 24" fill="none"
             xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false" role="img" aria-label="Owl icon">
          <path fill="#6C63FF" d="M12 2C9.243 2 7 4.243 7 7c0 2.757 2.243 5 5 5s5-2.243 5-5c0-2.757-2.243-5-5-5zM5 21c0-2.761 4-4 7-4s7 1.239 7 4v1H5v-1z"/>
        </svg>
      `;
      return wrap;
    }

    // ======== Language detection (kept) ========
    let currentLang = 'en-US';

    function detectLanguage(text) {
      const portugueseWords = ['o', 'a', 'de', 'que', 'não', 'é', 'em', 'por', 'com', 'para'];
      const englishWords = ['the', 'and', 'is', 'of', 'to', 'in', 'that', 'it', 'on', 'for'];
      const t = (text || '').toLowerCase();

      const ptCount = portugueseWords.reduce((c, w) => c + (t.includes(w) ? 1 : 0), 0);
      const enCount = englishWords.reduce((c, w) => c + (t.includes(w) ? 1 : 0), 0);

      return ptCount > enCount ? 'pt-BR' : 'en-US';
    }

    // ======== Menu ========
    function toggleMenu() {
      const menu = document.getElementById('sideMenu');
      menu.classList.toggle('open');
    }

    // ======== DOM refs ========
    const input = document.getElementById('messageInput');
    const inputArea = document.querySelector('.input-area');
    const responseDiv = document.getElementById('response');
    const sendButton = document.getElementById('send-btn');
    const readAloudButton = document.getElementById('read-aloud-btn');
    const micButton = document.getElementById('mic-btn');

    // ======== Speech Recognition ========
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    if (SpeechRecognition) {
      const recognition = new SpeechRecognition();
      recognition.lang = currentLang || 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      let recognizing = false;

      micButton.addEventListener('click', () => {
        if (recognizing) {
          recognition.stop();
          recognizing = false;
          micButton.textContent = 'Micro';
        } else {
          recognition.lang = currentLang || 'en-US';
          recognition.start();
          recognizing = true;
          micButton.textContent = 'stop';
        }
      });

      recognition.addEventListener('result', (event) => {
        const transcript = event.results[0][0].transcript;
        input.textContent = transcript;
        input.focus();
      });

      recognition.addEventListener('end', () => {
        recognizing = false;
        micButton.textContent = 'Micro';
      });

      recognition.addEventListener('error', (event) => {
        console.error('Erro no reconhecimento de voz:', event.error);
        recognizing = false;
        micButton.textContent = 'Micro';
      });
    } else {
      // no alert spam in production; keep silent or show soft UI message
      console.warn('Reconhecimento de voz não suportado neste navegador.');
    }

    // Focus input on click on bubble
    inputArea.addEventListener('click', () => input.focus());

    // Cursor helper (kept)
    function ensureCursorVisible(el) {
      if (el.textContent.trim() === '') {
        el.textContent = '\u200B';
        el.focus();

        const range = document.createRange();
        const sel = window.getSelection();
        range.setStart(el.childNodes[0], 1);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    function clearContentEditable(el) {
      el.textContent = '\u200B';
      const range = document.createRange();
      const sel = window.getSelection();
      if (el.childNodes.length > 0) {
        range.setStart(el.childNodes[0], 1);
        range.collapse(true);
        sel.removeAllRanges();
        sel.addRange(range);
      }
    }

    input.addEventListener('input', () => {
      setTimeout(() => ensureCursorVisible(input), 0);
    });

    window.addEventListener('load', () => {
      ensureCursorVisible(input);
      if (window.innerWidth >= 601) {
        const menu = document.getElementById('sideMenu');
        if (menu && !menu.classList.contains('open')) menu.classList.add('open');
      }
    });

    // Enter send (no Shift)
    input.addEventListener('keydown', (event) => {
      if (event.key === 'Enter' && !event.shiftKey) {
        event.preventDefault();
        const message = input.textContent.replace(/\u200B/g, '').trim();
        if (message !== "") {
          sendMessage(message);
          blurMobileKeyboard();
        }
      }
    });

    function blurMobileKeyboard() {
      input.blur();
      setTimeout(() => {
        const hiddenInput = document.createElement('input');
        hiddenInput.type = 'text';
        hiddenInput.style.position = 'absolute';
        hiddenInput.style.opacity = 0;
        hiddenInput.style.height = 0;
        hiddenInput.style.fontSize = '16px';
        document.body.appendChild(hiddenInput);
        hiddenInput.focus();
        setTimeout(() => hiddenInput.remove(), 100);
      }, 100);
    }

    // ======== Safe render helpers ========
    function appendUserMessage(text) {
      const div = document.createElement('div');
      div.className = 'user-message';
      div.textContent = text; // SAFE
      responseDiv.appendChild(div);
      responseDiv.scrollTop = responseDiv.scrollHeight;
      document.body.classList.add('chat-started');
    }

    function appendTypingIndicator() {
      const div = document.createElement('div');
      div.className = 'typing-indicator';
      div.id = 'typing-indicator';
      div.textContent = "Dr. Owl is typing...";
      responseDiv.appendChild(div);
      responseDiv.scrollTop = responseDiv.scrollHeight;
    }

    function removeTypingIndicator() {
      const el = document.getElementById('typing-indicator');
      if (el) el.remove();
    }

    function appendBotMessage(markdownText, followupQuestions = []) {
      // markdown -> html -> sanitize
      const rawHtml = marked.parse(markdownText || '');
      const cleanHtml = sanitizeBotHtml(rawHtml);

      const wrap = document.createElement('div');
      wrap.className = 'bot-message';

      const iconEl = createBotIconEl();
      const textEl = document.createElement('div');
      textEl.className = 'bot-text';
      textEl.innerHTML = cleanHtml; // SAFE because sanitized

      wrap.appendChild(iconEl);
      wrap.appendChild(textEl);

      responseDiv.appendChild(wrap);

      // Add follow-up questions (safe)
      if (Array.isArray(followupQuestions) && followupQuestions.length) {
        followupQuestions.forEach(q => {
          const qDiv = document.createElement('div');
          qDiv.className = 'clickable-question';
          qDiv.textContent = q; // SAFE
          qDiv.dataset.question = q;
          responseDiv.appendChild(qDiv);
        });
      }

      enforceSafeLinks(textEl);

      // Scroll into view
      wrap.scrollIntoView({ behavior: 'smooth', block: 'start' });

      document.body.classList.add('chat-started');
    }

    // Email prompt (built via DOM, not HTML string)
    let emailPromptShown = false;

    function appendEmailPromptOnce() {
      if (emailPromptShown) return;
      emailPromptShown = true;

      const wrap = document.createElement('div');
      wrap.className = 'bot-message';
      wrap.id = 'email-prompt';

      wrap.appendChild(createBotIconEl());

      const body = document.createElement('div');
      body.className = 'bot-text';

      const p = document.createElement('p');
      p.style.marginBottom = '12px';
      p.style.color = '#2f2c63';
      p.textContent = 'Want to receive personalized health tips from Dr. Owl?';

      const inputEmail = document.createElement('input');
      inputEmail.type = 'email';
      inputEmail.id = 'userEmail';
      inputEmail.placeholder = 'Enter your email';
      inputEmail.style.padding = '10px';
      inputEmail.style.fontSize = '14px';
      inputEmail.style.borderRadius = '8px';
      inputEmail.style.border = '1px solid #ccc';
      inputEmail.style.width = '70%';
      inputEmail.style.maxWidth = '300px';

      const btn = document.createElement('button');
      btn.type = 'button';
      btn.textContent = 'Subscribe';
      btn.style.marginLeft = '12px';
      btn.style.marginTop = '8px';
      btn.style.padding = '10px 16px';
      btn.style.fontSize = '14px';
      btn.style.backgroundColor = '#2f2c63';
      btn.style.color = 'white';
      btn.style.border = 'none';
      btn.style.borderRadius = '8px';
      btn.style.cursor = 'pointer';
      btn.addEventListener('click', submitEmail);

      body.appendChild(p);
      body.appendChild(inputEmail);
      body.appendChild(btn);

      wrap.appendChild(body);
      responseDiv.appendChild(wrap);
    }

    // ======== Send message (SAFE) ========
    async function sendMessage(message, selectedQuestion = null) {
      const msg = (message || '').trim();
      if (!msg && !selectedQuestion) return;

      // show user message only when it's typed (not when it's a follow-up click we already appended)
      if (msg && !selectedQuestion) {
        appendUserMessage(msg);
      }

      appendTypingIndicator();

      try {
        const res = await fetch('/api/chat', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ message: msg, selectedQuestion })
        });

        let data = null;
        try {
          data = await res.json();
        } catch {
          data = null;
        }

        removeTypingIndicator();

        if (!res.ok || !data) {
          appendBotMessage("Sorry — I couldn't reach the server. Please try again.");
          clearContentEditable(input);
          return;
        }

        let content = "";
        let followupQuestions = [];

        if (typeof data.reply === 'string') {
          content = data.reply;
          followupQuestions = Array.isArray(data.followupQuestions) ? data.followupQuestions : [];
        } else if (data.choices && data.choices.length > 0 && data.choices[0]?.message?.content) {
          content = data.choices[0].message.content;
        } else {
          content = "Sorry — I received an unexpected response format.";
        }

        currentLang = detectLanguage(content);

        appendBotMessage(content, followupQuestions);

        // optional email prompt after first bot response
        appendEmailPromptOnce();

        clearContentEditable(input);
      } catch (err) {
        removeTypingIndicator();
        console.error(err);
        appendBotMessage("Error communicating with server.");
      }
    }

    // Send button
    sendButton.addEventListener('click', () => {
      const message = input.textContent.replace(/\u200B/g, '').trim();
      if (message !== "") {
        sendMessage(message);
        blurMobileKeyboard();
      }
    });

    // Clickable follow-up handler (SAFE)
    document.addEventListener('click', (e) => {
      const el = e.target;
      if (el && el.classList && el.classList.contains('clickable-question')) {
        const question = (el.dataset.question || '').trim();
        if (!question) return;

        appendUserMessage(question);
        sendMessage(question, true);
      }
    });

    // ======== Read aloud ========
    let voices = [];
    function loadVoices() { voices = speechSynthesis.getVoices(); }
    speechSynthesis.onvoiceschanged = loadVoices;
    loadVoices();

    let lastReadIndex = -1;
    readAloudButton?.addEventListener('click', () => {
      if (speechSynthesis.speaking) {
        speechSynthesis.cancel();
        return;
      }

      const botMessages = responseDiv.querySelectorAll('.bot-message .bot-text');
      if (!botMessages || botMessages.length === 0) return;

      const newMessages = Array.from(botMessages).slice(lastReadIndex + 1);
      if (newMessages.length === 0) return;

      lastReadIndex = botMessages.length - 1;

      const texts = newMessages
        .map(el => (el.textContent || '').trim())
        .filter(t => t.length > 0);

      if (texts.length === 0) return;

      const textToRead = texts.join('. ');
      const utterance = new SpeechSynthesisUtterance(textToRead);
      utterance.lang = currentLang || 'en-US';

      const voice = voices.find(v => v.lang === utterance.lang || v.lang.startsWith((utterance.lang || 'en').split('-')[0]));
      if (voice) utterance.voice = voice;

      speechSynthesis.speak(utterance);
    });

    // ======== Email submit (SAFE) ========
    async function submitEmail() {
      const emailInput = document.getElementById('userEmail');
      const email = (emailInput?.value || '').trim();
      if (!email) {
        alert('Please enter a valid email.');
        return;
      }

      try {
        const res = await fetch('/api/subscribe.js', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ email })
        });

        if (res.ok) {
          alert('✅ Thank you! Your email was successfully submitted.');
        } else {
          alert('❌ There was an error submitting your email.');
        }
      } catch (err) {
        alert('⚠️ Connection error. Please try again later.');
      }
    }

    // Optional: menu click can prefill question (SAFE)
    document.getElementById('sideMenu')?.addEventListener('click', (e) => {
      const a = e.target.closest('a[data-menu]');
      if (!a) return;
      e.preventDefault();
      const label = (a.textContent || '').trim();
      if (!label) return;
      appendUserMessage(label);
      sendMessage(label, true);
    });
  </script>
</body>
</html>

