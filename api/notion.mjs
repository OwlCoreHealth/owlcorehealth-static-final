import { Client } from "@notionhq/client";

// ‚úÖ Instanciando o cliente do Notion
const notion = new Client({
  auth: "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" // Substitua pela sua chave de autentica√ß√£o
});

const databaseId = "1fda050ee113804aa5e9dd1b01e31066"; // ID do banco de dados

// üîç Fun√ß√£o de extra√ß√£o de palavras-chave
function extractKeywords(text) {
  const stopwords = [
    "the", "and", "for", "with", "from", "that", "this", "you", "your", "in", "to", "is", "it", "on", "a", "of", "as", "at", "by", "be", "are", "have", "was", "were", "not", "but", "or", "an", "we", "they", "he", "she", "it", "I"
  ];

  return text
    .toLowerCase() // Converte para min√∫sculas
    .split(/\W+/) // Divide o texto por n√£o-palavras (como espa√ßos, pontua√ß√£o)
    .filter(word => word.length > 3 && !stopwords.includes(word) && /^[a-zA-Z]+$/.test(word)); // Filtra palavras v√°lidas
}

// Fun√ß√£o para detectar o idioma da mensagem
function detectLanguage(message) {
  const portugueseWords = ["√©", "voc√™", "tem", "dores", "sintoma"];
  const englishWords = ["is", "you", "have", "pain", "symptom"];
  
  const messageLower = message.toLowerCase();
  let portugueseCount = 0;
  let englishCount = 0;
  
  portugueseWords.forEach(word => {
    if (messageLower.includes(word)) portugueseCount++;
  });
  
  englishWords.forEach(word => {
    if (messageLower.includes(word)) englishCount++;
  });

  return portugueseCount > englishCount ? "pt" : "en";
}

// Fun√ß√£o principal para consulta ao Notion
export async function getSymptomContext(userMessage, userName) {
  try {
    // Detectar idioma da mensagem
    const language = detectLanguage(userMessage);
    
    // Frases de abertura sarc√°stica quando o formul√°rio n√£o for preenchido
    const frasesSarcasticas = {
      pt: [
        "Sem seu nome, idade ou peso, posso te dar conselhos‚Ä¶ t√£o √∫teis quanto ler a sorte no biscoito da sorte.",
        "Ignorar o formul√°rio? Estrat√©gia ousada. Vamos ver no que d√°.",
        "Voc√™ ignora sua sa√∫de assim tamb√©m? Posso tentar adivinhar seu perfil com superpoderes‚Ä¶ ou n√£o."
      ],
      en: [
        "Without your name, age or weight, my advice is about as useful as a fortune cookie.",
        "Skipping the form? Bold move. Let's see how that works out.",
        "Do you ignore your health like this too? I could guess with superpowers‚Ä¶ or not."
      ]
    };

    // Verificando se o formul√°rio foi preenchido
    const hasForm = userName && userName.trim() !== ""; // Verifica se o nome foi fornecido
    const intro = hasForm
      ? language === "pt" 
        ? `${userName}, vamos focar nisso.` 
        : `${userName}, let's focus on this.`
      : frasesSarcasticas[language][Math.floor(Math.random() * frasesSarcasticas[language].length)]; // Escolhe uma frase sarc√°stica aleat√≥ria

    const keywords = extractKeywords(userMessage);
    console.log("üß† Palavras-chave extra√≠das:", keywords);

    if (!keywords.length) {
      return {
        sintoma: "unknown",
        intro: intro,
        scientificExplanation: getScientificExplanation("unknown", language),
        followupQuestions: getFollowupQuestions("unknown", language)
      };
    }

    const filter = {
      or: keywords.map(word => ({
        property: "Palavras-chave", // Nome da propriedade no banco de dados do Notion
        rich_text: {
          contains: word // Verificar se cada palavra-chave est√° no campo "Palavras-chave"
        }
      }))
    };

    console.log("üì¶ Filtro enviado ao Notion:", JSON.stringify(filter, null, 2));

    const response = await notion.databases.query({
      database_id: databaseId // ID do banco de dados
    });

    console.log("üì® Resposta do Notion:", JSON.stringify(response, null, 2));

    // Detectando o sintoma com base nas palavras-chave
    let sintomaKey = "unknown";
    
    if (userMessage.toLowerCase().includes("stomach") || 
        userMessage.toLowerCase().includes("est√¥mago") || 
        userMessage.toLowerCase().includes("estomago") || 
        userMessage.toLowerCase().includes("barriga")) {
      sintomaKey = "stomach_pain";
    } else if (userMessage.toLowerCase().includes("headache") || 
               userMessage.toLowerCase().includes("dor de cabe√ßa") || 
               userMessage.toLowerCase().includes("cabe√ßa")) {
      sintomaKey = "headache";
    } else if (userMessage.toLowerCase().includes("fatigue") || 
               userMessage.toLowerCase().includes("cansa√ßo") || 
               userMessage.toLowerCase().includes("fadiga") || 
               userMessage.toLowerCase().includes("energia")) {
      sintomaKey = "fatigue";
    } else if (userMessage.toLowerCase().includes("back pain") || 
               userMessage.toLowerCase().includes("dor nas costas") || 
               userMessage.toLowerCase().includes("lombar")) {
      sintomaKey = "back_pain";
    }

    // Retornando um objeto estruturado com todas as informa√ß√µes necess√°rias
    return {
      sintoma: sintomaKey,
      intro: intro,
      scientificExplanation: getScientificExplanation(sintomaKey, language),
      followupQuestions: getFollowupQuestions(sintomaKey, language)
    };

  } catch (error) {
    console.error("‚ùå Erro ao consultar o Notion:", error);
    return {
      sintoma: "unknown",
      intro: language === "pt" ? "Desculpe, tive um problema ao processar sua consulta." : "Sorry, I had an issue processing your query.",
      scientificExplanation: getScientificExplanation("unknown", language),
      followupQuestions: getFollowupQuestions("unknown", language)
    };
  }
}

// Fun√ß√£o para obter explica√ß√µes cient√≠ficas com base no sintoma e idioma
function getScientificExplanation(symptom, language) {
  const explanations = {
    stomach_pain: {
      pt: `As dores de est√¥mago podem ter diversas causas, desde simples at√© mais complexas. Vamos explorar algumas possibilidades cient√≠ficas:

A dor abdominal √© processada atrav√©s de nociceptores (receptores de dor) que enviam sinais ao c√©rebro via nervos aferentes. Estes sinais s√£o interpretados pelo c√≥rtex somatossensorial, resultando na sensa√ß√£o de dor que voc√™ experimenta.

Causas comuns incluem:

1. **Gastrite ou Inflama√ß√£o G√°strica**: Ocorre quando o revestimento do est√¥mago se inflama, geralmente devido √† infec√ß√£o por H. pylori ou uso prolongado de anti-inflamat√≥rios. A inflama√ß√£o ativa os nociceptores da mucosa g√°strica.

2. **Refluxo Gastroesof√°gico**: Acontece quando o √°cido estomacal retorna ao es√¥fago, irritando seu revestimento. O esf√≠ncter esof√°gico inferior (EEI) normalmente impede esse refluxo, mas pode enfraquecer devido a diversos fatores.

3. **S√≠ndrome do Intestino Irrit√°vel**: Condi√ß√£o funcional que afeta o movimento intestinal e a sensibilidade visceral. Estudos mostram uma desregula√ß√£o do eixo c√©rebro-intestino, com hipersensibilidade dos nervos ent√©ricos.

4. **Estresse e Ansiedade**: O eixo hipot√°lamo-pituit√°ria-adrenal (HPA) ativa-se durante o estresse, liberando cortisol e adrenalina, que podem alterar a motilidade gastrointestinal e aumentar a sensibilidade √† dor.`,
      
      en: `Stomach pain can have various causes, ranging from simple to more complex. Let's explore some scientific possibilities:

Abdominal pain is processed through nociceptors (pain receptors) that send signals to the brain via afferent nerves. These signals are interpreted by the somatosensory cortex, resulting in the pain sensation you experience.

Common causes include:

1. **Gastritis or Gastric Inflammation**: Occurs when the stomach lining becomes inflamed, usually due to H. pylori infection or prolonged use of anti-inflammatory drugs. The inflammation activates nociceptors in the gastric mucosa.

2. **Gastroesophageal Reflux**: Happens when stomach acid flows back into the esophagus, irritating its lining. The lower esophageal sphincter (LES) normally prevents this reflux but can weaken due to various factors.

3. **Irritable Bowel Syndrome**: A functional condition affecting intestinal movement and visceral sensitivity. Studies show a dysregulation of the brain-gut axis, with hypersensitivity of enteric nerves.

4. **Stress and Anxiety**: The hypothalamic-pituitary-adrenal (HPA) axis activates during stress, releasing cortisol and adrenaline, which can alter gastrointestinal motility and increase pain sensitivity.`
    },
    
    headache: {
      pt: `As dores de cabe√ßa s√£o uma das queixas mais comuns e podem ter diversas origens neurol√≥gicas e vasculares. Vamos explorar a ci√™ncia por tr√°s delas:

A dor de cabe√ßa ocorre quando receptores de dor nas estruturas sens√≠veis da cabe√ßa s√£o ativados. Estes incluem vasos sangu√≠neos, m√∫sculos, nervos e tecidos que envolvem o c√©rebro. Curiosamente, o pr√≥prio tecido cerebral n√£o possui receptores de dor.

Tipos comuns e suas causas:

1. **Enxaqueca**: Caracterizada por dor puls√°til, geralmente unilateral, e frequentemente acompanhada de n√°usea e sensibilidade √† luz. Estudos neurofisiol√≥gicos mostram que a enxaqueca envolve a ativa√ß√£o do sistema trigeminovascular, com libera√ß√£o de neuropept√≠deos inflamat√≥rios como o pept√≠deo relacionado ao gene da calcitonina (CGRP).

2. **Cefaleia Tensional**: A mais comum, caracterizada por dor em press√£o bilateral. Est√° associada √† contra√ß√£o prolongada dos m√∫sculos pericranianos e cervicais, com sensibiliza√ß√£o dos nociceptores perif√©ricos e centrais.

3. **Cefaleia em Salvas**: Extremamente dolorosa, ocorre em per√≠odos ou "salvas". Envolve ativa√ß√£o do nervo trig√™meo e do hipot√°lamo, com dilata√ß√£o dos vasos sangu√≠neos da regi√£o orbital.

4. **Cefaleia por Uso Excessivo de Medicamentos**: Paradoxalmente, o uso frequente de analg√©sicos pode levar a dores de cabe√ßa cr√¥nicas, atrav√©s de mecanismos de sensibiliza√ß√£o central e altera√ß√µes nos receptores de dor.`,
      
      en: `Headaches are one of the most common complaints and can have various neurological and vascular origins. Let's explore the science behind them:

Headache occurs when pain receptors in the head's sensitive structures are activated. These include blood vessels, muscles, nerves, and tissues surrounding the brain. Interestingly, brain tissue itself doesn't have pain receptors.

Common types and their causes:

1. **Migraine**: Characterized by pulsating pain, usually unilateral, and often accompanied by nausea and light sensitivity. Neurophysiological studies show that migraine involves activation of the trigeminovascular system, with the release of inflammatory neuropeptides such as calcitonin gene-related peptide (CGRP).

2. **Tension Headache**: The most common type, characterized by bilateral pressure pain. It's associated with prolonged contraction of pericranial and cervical muscles, with sensitization of peripheral and central nociceptors.

3. **Cluster Headache**: Extremely painful, occurring in periods or "clusters." It involves activation of the trigeminal nerve and hypothalamus, with dilation of blood vessels in the orbital region.

4. **Medication Overuse Headache**: Paradoxically, frequent use of painkillers can lead to chronic headaches, through mechanisms of central sensitization and changes in pain receptors.`
    },
    
    fatigue: {
      pt: `A fadiga √© uma sensa√ß√£o complexa de cansa√ßo que vai al√©m do simples desgaste f√≠sico. Vamos explorar os mecanismos cient√≠ficos por tr√°s desse sintoma:

A fadiga envolve m√∫ltiplos sistemas fisiol√≥gicos e √© regulada por uma intera√ß√£o complexa entre o sistema nervoso central, o sistema end√≥crino e o sistema imunol√≥gico.

Causas biol√≥gicas comuns:

1. **Deple√ß√£o Energ√©tica Celular**: A fadiga frequentemente resulta de altera√ß√µes no metabolismo energ√©tico celular. As mitoc√¥ndrias, "usinas de energia" das c√©lulas, podem ter sua fun√ß√£o comprometida por diversos fatores, reduzindo a produ√ß√£o de ATP (adenosina trifosfato), a principal mol√©cula energ√©tica do corpo.

2. **Desregula√ß√£o do Eixo HPA**: O eixo hipot√°lamo-pituit√°ria-adrenal regula nossa resposta ao estresse e os n√≠veis de cortisol. O estresse cr√¥nico pode levar √† desregula√ß√£o deste eixo, resultando em fadiga persistente e altera√ß√µes no ciclo sono-vig√≠lia.

3. **Inflama√ß√£o Sist√™mica**: Citocinas pr√≥-inflamat√≥rias como IL-6, TNF-alfa e IL-1beta podem induzir comportamento de doen√ßa, que inclui fadiga como sintoma protetor. Este mecanismo evolutivo conserva energia durante infec√ß√µes ou les√µes.

4. **Desequil√≠brios Hormonais**: Altera√ß√µes nos n√≠veis de horm√¥nios como tireoidianos, cortisol, melatonina e horm√¥nios sexuais podem afetar significativamente os n√≠veis de energia. Por exemplo, o hipotireoidismo reduz o metabolismo basal, resultando em fadiga.`,
      
      en: `Fatigue is a complex sensation of tiredness that goes beyond simple physical wear. Let's explore the scientific mechanisms behind this symptom:

Fatigue involves multiple physiological systems and is regulated by a complex interaction between the central nervous system, the endocrine system, and the immune system.

Common biological causes:

1. **Cellular Energy Depletion**: Fatigue often results from alterations in cellular energy metabolism. Mitochondria, the cell's "power plants," can have their function compromised by various factors, reducing the production of ATP (adenosine triphosphate), the body's main energy molecule.

2. **HPA Axis Dysregulation**: The hypothalamic-pituitary-adrenal axis regulates our stress response and cortisol levels. Chronic stress can lead to dysregulation of this axis, resulting in persistent fatigue and alterations in the sleep-wake cycle.

3. **Systemic Inflammation**: Pro-inflammatory cytokines such as IL-6, TNF-alpha, and IL-1beta can induce sickness behavior, which includes fatigue as a protective symptom. This evolutionary mechanism conserves energy during infections or injuries.

4. **Hormonal Imbalances**: Changes in hormone levels such as thyroid hormones, cortisol, melatonin, and sex hormones can significantly affect energy levels. For example, hypothyroidism reduces basal metabolism, resulting in fatigue.`
    },
    
    back_pain: {
      pt: `A dor nas costas, especialmente na regi√£o lombar, √© uma das queixas mais comuns e pode ter origens complexas. Vamos explorar a ci√™ncia por tr√°s desse sintoma:

A dor lombar envolve uma intera√ß√£o entre estruturas anat√¥micas, processos inflamat√≥rios e mecanismos neurais de processamento da dor.

Causas anat√¥micas e fisiol√≥gicas:

1. **Disfun√ß√£o Musculoesquel√©tica**: A coluna vertebral √© sustentada por m√∫sculos, ligamentos e tend√µes. Desequil√≠brios na for√ßa muscular, especialmente no core (m√∫sculos abdominais e paravertebrais), podem levar a sobrecarga e microles√µes nas estruturas de suporte, ativando nociceptores locais.

2. **Altera√ß√µes Discais**: Os discos intervertebrais funcionam como amortecedores entre as v√©rtebras. Com o tempo ou devido a traumas, podem ocorrer protrus√µes ou h√©rnias discais, onde o n√∫cleo pulposo pressiona ra√≠zes nervosas, causando dor radicular (ci√°tica).

3. **Sensibiliza√ß√£o Central**: Em casos cr√¥nicos, ocorre um fen√¥meno chamado sensibiliza√ß√£o central, onde o sistema nervoso se torna hipersens√≠vel, amplificando sinais de dor mesmo ap√≥s a resolu√ß√£o da les√£o inicial. Neurotransmissores como subst√¢ncia P e glutamato est√£o envolvidos neste processo.

4. **Componente Psicossocial**: Estudos mostram que fatores como estresse, ansiedade e depress√£o podem amplificar a percep√ß√£o da dor lombar atrav√©s da modula√ß√£o descendente da dor, envolvendo √°reas cerebrais como a subst√¢ncia cinzenta periaquedutal e o locus coeruleus.`,
      
      en: `Back pain, especially in the lumbar region, is one of the most common complaints and can have complex origins. Let's explore the science behind this symptom:

Lumbar pain involves an interaction between anatomical structures, inflammatory processes, and neural mechanisms of pain processing.

Anatomical and physiological causes:

1. **Musculoskeletal Dysfunction**: The spine is supported by muscles, ligaments, and tendons. Imbalances in muscle strength, especially in the core (abdominal and paravertebral muscles), can lead to overload and microinjuries in supporting structures, activating local nociceptors.

2. **Disc Changes**: Intervertebral discs function as cushions between vertebrae. Over time or due to trauma, disc protrusions or herniations can occur, where the nucleus pulposus presses on nerve roots, causing radicular pain (sciatica).

3. **Central Sensitization**: In chronic cases, a phenomenon called central sensitization occurs, where the nervous system becomes hypersensitive, amplifying pain signals even after resolution of the initial injury. Neurotransmitters such as substance P and glutamate are involved in this process.

4. **Psychosocial Component**: Studies show that factors such as stress, anxiety, and depression can amplify the perception of back pain through descending pain modulation, involving brain areas such as the periaqueductal gray matter and locus coeruleus.`
    },
    
    unknown: {
      pt: `Quando os sintomas n√£o s√£o espec√≠ficos, √© importante considerar uma abordagem cient√≠fica abrangente. Vamos explorar alguns conceitos gerais sobre como o corpo processa sintomas:

Os sintomas s√£o sinais de que algo pode estar fora do equil√≠brio no organismo. Do ponto de vista cient√≠fico, eles representam:

1. **Mecanismos de Alerta**: O corpo possui sistemas sofisticados de detec√ß√£o de altera√ß√µes internas e externas. Receptores especializados (nociceptores, mecanorreceptores, quimiorreceptores) captam est√≠mulos potencialmente prejudiciais e os transformam em sinais el√©tricos.

2. **Integra√ß√£o Neural**: Estes sinais s√£o processados pelo sistema nervoso central, especialmente pelo t√°lamo e c√≥rtex somatossensorial, que interpretam a natureza, localiza√ß√£o e intensidade do est√≠mulo.

3. **Resposta Inflamat√≥ria**: Muitos sintomas est√£o associados √† inflama√ß√£o, um mecanismo protetor que envolve a libera√ß√£o de mediadores como histamina, prostaglandinas e citocinas. Estes mediadores podem ativar receptores de dor e causar outros sintomas como incha√ßo e calor local.

4. **Eixo Psiconeuroendocrinoimunol√≥gico**: Existe uma comunica√ß√£o bidirecional entre o sistema nervoso, end√≥crino e imunol√≥gico. Fatores psicol√≥gicos como estresse e ansiedade podem influenciar processos fisiol√≥gicos atrav√©s deste eixo, alterando a percep√ß√£o e manifesta√ß√£o de sintomas.`,
      
      en: `When symptoms are not specific, it's important to consider a comprehensive scientific approach. Let's explore some general concepts about how the body processes symptoms:

Symptoms are signs that something may be out of balance in the organism. From a scientific perspective, they represent:

1. **Alert Mechanisms**: The body has sophisticated systems for detecting internal and external changes. Specialized receptors (nociceptors, mechanoreceptors, chemoreceptors) capture potentially harmful stimuli and transform them into electrical signals.

2. **Neural Integration**: These signals are processed by the central nervous system, especially by the thalamus and somatosensory cortex, which interpret the nature, location, and intensity of the stimulus.

3. **Inflammatory Response**: Many symptoms are associated with inflammation, a protective mechanism involving the release of mediators such as histamine, prostaglandins, and cytokines. These mediators can activate pain receptors and cause other symptoms such as swelling and local heat.

4. **Psychoneuroendocrinoimmunological Axis**: There is bidirectional communication between the nervous, endocrine, and immune systems. Psychological factors such as stress and anxiety can influence physiological processes through this axis, altering the perception and manifestation of symptoms.`
    }
  };
  
  return explanations[symptom][language] || explanations.unknown[language];
}

// Fun√ß√£o para obter perguntas de follow-up com base no sintoma e idioma
function getFollowupQuestions(symptom, language) {
  const questions = {
    stomach_pain: {
      pt: [
        "Voc√™ tem comido alimentos picantes ou gordurosos recentemente?",
        "Voc√™ tem se sentido estressado ultimamente? O estresse pode afetar seu est√¥mago.",
        "Voc√™ tem hist√≥rico de condi√ß√µes como gastrite ou refluxo?"
      ],
      en: [
        "Have you been eating spicy or fatty foods recently?",
        "Have you been feeling stressed lately? Stress can affect your stomach.",
        "Do you have a history of conditions such as gastritis or reflux?"
      ]
    },
    headache: {
      pt: [
        "Voc√™ tem dormido o suficiente nas √∫ltimas noites?",
        "Voc√™ tem hist√≥rico de enxaquecas ou dores de cabe√ßa tensionais?",
        "Voc√™ passou por situa√ß√µes de estresse intenso recentemente?"
      ],
      en: [
        "Have you been getting enough sleep in the last few nights?",
        "Do you have a history of migraines or tension headaches?",
        "Have you experienced intense stress situations recently?"
      ]
    },
    fatigue: {
      pt: [
        "Voc√™ tem se alimentado de forma equilibrada e regular?",
        "Voc√™ tem praticado atividade f√≠sica regularmente?",
        "Voc√™ tem notado outros sintomas al√©m da fadiga, como dores musculares ou altera√ß√µes de humor?"
      ],
      en: [
        "Have you been eating a balanced and regular diet?",
        "Have you been exercising regularly?",
        "Have you noticed other symptoms besides fatigue, such as muscle pain or mood changes?"
      ]
    },
    back_pain: {
      pt: [
        "Voc√™ passa muito tempo sentado ou em posi√ß√µes que sobrecarregam a coluna?",
        "Voc√™ realiza exerc√≠cios espec√≠ficos para fortalecer a musculatura das costas?",
        "A dor irradia para outras partes do corpo, como pernas ou bra√ßos?"
      ],
      en: [
        "Do you spend a lot of time sitting or in positions that overload your spine?",
        "Do you perform specific exercises to strengthen your back muscles?",
        "Does the pain radiate to other parts of your body, such as legs or arms?"
      ]
    },
    unknown: {
      pt: [
        "Voc√™ poderia descrever mais detalhadamente os sintomas que est√° sentindo?",
        "H√° quanto tempo voc√™ vem sentindo esses sintomas?",
        "Voc√™ notou algum padr√£o ou fator que parece piorar ou melhorar os sintomas?"
      ],
      en: [
        "Could you describe in more detail the symptoms you are feeling?",
        "How long have you been experiencing these symptoms?",
        "Have you noticed any pattern or factor that seems to worsen or improve the symptoms?"
      ]
    }
  };
  
  return questions[symptom][language] || questions.unknown[language];
}

// Testando a fun√ß√£o
// const userMessage = "I have stomach pain"; // Altere conforme necess√°rio
// const userName = "Jo√£o";  // Substitua pelo nome do usu√°rio real

// getSymptomContext(userMessage, userName).then(response => {
//   console.log("üîé Resultado final:", response);
//   if (!response) {
//     console.log("‚ö†Ô∏è Nenhum resultado encontrado.");
//   } else {
//     console.log("‚úÖ Resultado encontrado!");
//   }
// });
